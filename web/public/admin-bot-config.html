<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Configuração de Frequência do Bot</title>
  <link rel="stylesheet" href="/admin-assets/styles.css">
</head>
<body>
  <h1>Configuração de Frequência de Postagem Automática</h1>
  <div class="form-group">
    <label for="scheduleStart">Horário de início:</label>
    <select id="scheduleStart" name="scheduleStart" class="form-control">
      <!-- opções de 00:00 a 23:00 -->
      <option value="00:00">00:00</option>
      <option value="01:00">01:00</option>
      <option value="02:00">02:00</option>
      <option value="03:00">03:00</option>
      <option value="04:00">04:00</option>
      <option value="05:00">05:00</option>
      <option value="06:00">06:00</option>
      <option value="07:00">07:00</option>
      <option value="08:00">08:00</option>
      <option value="09:00">09:00</option>
      <option value="10:00">10:00</option>
      <option value="11:00">11:00</option>
      <option value="12:00">12:00</option>
      <option value="13:00">13:00</option>
      <option value="14:00">14:00</option>
      <option value="15:00">15:00</option>
      <option value="16:00">16:00</option>
      <option value="17:00">17:00</option>
      <option value="18:00">18:00</option>
      <option value="19:00">19:00</option>
      <option value="20:00">20:00</option>
      <option value="21:00">21:00</option>
      <option value="22:00">22:00</option>
      <option value="23:00">23:00</option>
    </select>
  </div>
  <div class="form-group">
    <label for="scheduleEnd">Horário de término:</label>
    <select id="scheduleEnd" name="scheduleEnd" class="form-control">
      <!-- opções de 00:00 a 23:00 -->
      <option value="00:00">00:00</option>
      <option value="01:00">01:00</option>
      <option value="02:00">02:00</option>
      <option value="03:00">03:00</option>
      <option value="04:00">04:00</option>
      <option value="05:00">05:00</option>
      <option value="06:00">06:00</option>
      <option value="07:00">07:00</option>
      <option value="08:00">08:00</option>
      <option value="09:00">09:00</option>
      <option value="10:00">10:00</option>
      <option value="11:00">11:00</option>
      <option value="12:00">12:00</option>
      <option value="13:00">13:00</option>
      <option value="14:00">14:00</option>
      <option value="15:00">15:00</option>
      <option value="16:00">16:00</option>
      <option value="17:00">17:00</option>
      <option value="18:00">18:00</option>
      <option value="19:00">19:00</option>
      <option value="20:00">20:00</option>
      <option value="21:00">21:00</option>
      <option value="22:00">22:00</option>
      <option value="23:00">23:00</option>
    </select>
  </div>
  <div class="form-group">
    <label for="scheduleInterval">Intervalo (minutos):</label>
    <select id="scheduleInterval" name="scheduleInterval" class="form-control">
      <option value="5">A cada 5 minutos</option>
      <option value="10">A cada 10 minutos</option>
      <option value="15">A cada 15 minutos</option>
      <option value="30">A cada 30 minutos</option>
      <option value="45">A cada 45 minutos</option>
      <option value="60" selected>A cada 60 minutos</option>
    </select>
  </div>
  <button onclick="saveConfig()">Salvar</button>
   <div id="status"></div>
   <div style="margin-top:1rem">
     <strong>Expressão CRON atual:</strong>
     <div id="currentCron" style="font-family:monospace; margin-top:0.5rem;">carregando...</div>
   </div>
  <script>
    async function getCsrfToken() {
      const res = await fetch('/api/csrf-token');
      if (!res.ok) return null;
      const data = await res.json();
      return data.csrfToken;
    }

    async function loadConfig() {
      const res = await fetch('/api/admin/bot-config/schedule');
      if (!res.ok) {
        document.getElementById('status').innerText = `Erro ao carregar configuração (HTTP ${res.status}). Verifique se você está autenticado.`;
        document.getElementById('currentCron').innerText = 'não disponível';
        return;
      }
      const data = await res.json();
      if (data.start) document.getElementById('scheduleStart').value = data.start;
      if (data.end) document.getElementById('scheduleEnd').value = data.end;
      if (data.interval) document.getElementById('scheduleInterval').value = data.interval;
      document.getElementById('currentCron').innerText = data.cron || 'não disponível';
    }

    async function saveConfig() {
      const start = document.getElementById('scheduleStart').value;
      const end = document.getElementById('scheduleEnd').value;
      const interval = document.getElementById('scheduleInterval').value;
      const csrfToken = await getCsrfToken();
      const res = await fetch('/api/admin/bot-config/schedule', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({ start, end, interval })
      });
      if (res.ok) {
        document.getElementById('status').innerText = 'Configuração salva com sucesso! Atualizando...';
        // Re-load the configuration from server to ensure displayed cron matches persisted value
        await loadConfig();
        document.getElementById('status').innerText = 'Configuração salva com sucesso!';
      } else {
        let msg = `Erro ao salvar configuração (HTTP ${res.status}).`;
        try {
          const errData = await res.json();
          if (errData && errData.error) msg += ' ' + (errData.error_msg || errData.error || '');
        } catch {}
        document.getElementById('status').innerText = msg;
      }
    }
    loadConfig();
  </script>
</body>
</html>
